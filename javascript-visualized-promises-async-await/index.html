<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="7 â­ï¸ğŸ€ JavaScript Visualized: Promises &amp; Async/Await, åº„å¼•çš„åšå®¢">
    <meta name="description" content="æ— ç¥è®ºè€… æ— å…šæ´¾äººå£« è‹¥æ‰¹è¯„ä¸è‡ªç”± åˆ™èµç¾æ— æ„ä¹‰ ä½†æ¯«æ— æ ¹æ®çš„æ±¡è”‘è¯‹æ¯åˆ™æ— è€»è‡³æ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

    <title>7 â­ï¸ğŸ€ JavaScript Visualized: Promises &amp; Async/Await | åº„å¼•çš„åšå®¢</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/awesome.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">åº„å¼•çš„åšå®¢</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fa fa-home"></i>
      
      é¦–é¡µ
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fa fa-tags"></i>
      
      æ ‡ç­¾
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fa fa-bookmark"></i>
      
      åˆ†ç±»
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fa fa-user-circle"></i>
      
      å…³äº
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comment"></i>
      
      ç•™è¨€æ¿
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fa fa-users"></i>
      
      å‹æƒ…é“¾æ¥
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

  <div class="mobile-head bg-color">
    
    <img src="/medias/logo.png" class="logo-img circle responsive-img">
    
    <div class="logo-name">åº„å¼•çš„åšå®¢</div>
    <div class="logo-desc">
      
      æ— ç¥è®ºè€… æ— å…šæ´¾äººå£« è‹¥æ‰¹è¯„ä¸è‡ªç”± åˆ™èµç¾æ— æ„ä¹‰ ä½†æ¯«æ— æ ¹æ®çš„æ±¡è”‘è¯‹æ¯åˆ™æ— è€»è‡³æ
      
    </div>
  </div>

  

  <ul class="menu-list mobile-menu-list">
    
    <li class="m-nav-item">
      
      <a href="/" class="waves-effect waves-light">
        
        <i class="fa fa-home"></i>
        
        é¦–é¡µ
      </a>
      
        </li>
        
    <li class="m-nav-item">
      
      <a href="/tags" class="waves-effect waves-light">
        
        <i class="fa fa-tags"></i>
        
        æ ‡ç­¾
      </a>
      
        </li>
        
    <li class="m-nav-item">
      
      <a href="/categories" class="waves-effect waves-light">
        
        <i class="fa fa-bookmark"></i>
        
        åˆ†ç±»
      </a>
      
        </li>
        
    <li class="m-nav-item">
      
      <a href="/about" class="waves-effect waves-light">
        
        <i class="fa fa-user-circle"></i>
        
        å…³äº
      </a>
      
        </li>
        
    <li class="m-nav-item">
      
      <a href="/contact" class="waves-effect waves-light">
        
        <i class="fas fa-comment"></i>
        
        ç•™è¨€æ¿
      </a>
      
        </li>
        
    <li class="m-nav-item">
      
      <a href="/friends" class="waves-effect waves-light">
        
        <i class="fa fa-users"></i>
        
        å‹æƒ…é“¾æ¥
      </a>
      
        </li>
        
        
        <li><div class=" divider">
</div>
</li>
<li>
  <a href="https://github.com/zhuangyin8" class="waves-effect waves-light" target="_blank">
    <i class="fab fa-github"></i>
    Fork Me
  </a>
</li>

</ul>
</div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {

        0%,
        to {
            transform: rotate(0);
        }

        20%,
        60% {
            transform: rotate(-25deg);
        }

        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/zhuangyin8" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>
    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
  <div class="container" style="right: 0px;left: 0px;">
    <div class="row">
      <div class="col s12 m12 l12">
        <div class="brand">
          <h1 class="description center-align post-title">7 â­ï¸ğŸ€ JavaScript Visualized: Promises &amp; Async/Await</h1>
        </div>
      </div>
    </div>
  </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    /* #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    } */

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 400px;
        /* padding-left: 20px; */
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
        max-height: 900px;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 96px;
        /* padding-top: 15px;
        margin-bottom: 0; */
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 58px;
        height: 58px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 58px;
        font-size: 1.5rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s8">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Visualized/">
                                <span class="chip bg-color">Visualized</span>
                            </a>
                        
                            <a href="/tags/Promises/">
                                <span class="chip bg-color">Promises</span>
                            </a>
                        
                            <a href="/tags/Async/">
                                <span class="chip bg-color">Async</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s4 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark icon-category"></i>
                        
                            <a href="/categories/JavaScript/" class="post-category">
                                JavaScript
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus"></i>
                    å‘å¸ƒæ—¥æœŸ:;
                    2020-04-15
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p><a target="_blank" rel="noopener" href="https://dev.to/lydiahallie/javascript-visualized-promises-async-await-5gke">7 â­ï¸ğŸ€ JavaScript Visualized: Promises &amp; Async/Await</a></p>
</blockquote>
<p><img src="/images/lbkswjafvaeynxnrjuoq.png" alt="Cover image for â­ï¸ğŸ€  JavaScript Visualized: Promises &amp; Async/Await"></p>
<p>Ever had to deal with JS code that justâ€¦ didnâ€™t run the way you expected it to? Maybe it seemed like functions got executed at random, unpredictable times, or the execution got delayed. Thereâ€™s a chance you were dealing with a cool new feature that ES6 introduced: <strong>Promises</strong>!</p>
<p>My curiosity from many years ago has paid off and my sleepless nights have once again given me the time to make some animations. Time to talk about Promises: <strong>why</strong> would you use them, <strong>how</strong> do they work â€œunder the hoodâ€, and how can we write them in the most <strong>modern</strong> way?</p>
<blockquote>
<p>If you havenâ€™t read my previous post on the JavaScript Event Loop yet, it may be useful to read that first! Iâ€™ll be covering the event loop again assuming some basic knowledge about the call stack, Web API and the queue, but this time weâ€™ll also be covering some exciting extra features ğŸ¤©</p>
</blockquote>
<p>If youâ€™re already somewhat familiar with promises, here are some shortcuts to save you some precious scrolling time.</p>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>When writing JavaScript, we often have to deal with tasks that rely on other tasks! Letâ€™s say that we want to get an image, compress it, apply a filter, and save it ğŸ“¸</p>
<blockquote>
<p>åœ¨ç¼–å†™ JavaScript æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸è¦å¤„ç†ä¾èµ–å…¶ä»–ä»»åŠ¡çš„ä»»åŠ¡ï¼å‡è®¾æˆ‘ä»¬æƒ³è¦è·å–ä¸€ä¸ªå›¾åƒï¼Œå‹ç¼©å®ƒï¼Œåº”ç”¨è¿‡æ»¤å™¨ï¼Œç„¶åä¿å­˜å®ƒ ğŸ“¸</p>
</blockquote>
<p>The very first thing we need to do, is <em>get</em> the image that we want to edit. A <code>getImage</code> function can take care of this! Only once that image has been loaded successfully, we can pass that value to a <del><code>resizeImage</code></del> <code>compressImage</code> function. When the image has been resized successfully, we want to apply a filter to the image in the <code>applyFilter</code> function. After the image has been compressed and weâ€™ve added a filter, we want to save the image and let the user know that everything worked correctly! ğŸ¥³</p>
<blockquote>
<p>æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ <em>è·å–</em> æˆ‘ä»¬æƒ³è¦ç¼–è¾‘çš„å›¾åƒã€‚ <code>getImage</code> å‡½æ•°å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼åªæœ‰æˆåŠŸåŠ è½½è¯¥å›¾åƒåï¼Œæˆ‘ä»¬æ‰èƒ½å°†è¯¥å€¼ä¼ é€’ç»™ <code>compressImage</code> å‡½æ•°ã€‚æˆåŠŸè°ƒæ•´å›¾åƒå¤§å°åï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ <code>applyFilter</code> å‡½æ•°ä¸­å¯¹å›¾åƒåº”ç”¨è¿‡æ»¤å™¨ã€‚åœ¨å›¾åƒè¢«å‹ç¼©å¹¶æ·»åŠ è¿‡æ»¤å™¨åï¼Œæˆ‘ä»¬æƒ³åœ¨ <code>saveImage</code> å‡½æ•°ä¿å­˜å›¾åƒå¹¶è®©ç”¨æˆ·çŸ¥é“ä¸€åˆ‡æ­£å¸¸ï¼ ğŸ¥³</p>
</blockquote>
<p>In the end, weâ€™ll end up with something like this:</p>
<p><img src="/images/ixceqsql5hpdq8txx43s.png" alt="å›è°ƒå‡½æ•°ç‰ˆæœ¬çš„ getImage"></p>
<p>Hmmâ€¦ Notice anything here? Although itâ€™sâ€¦ <em>fine</em>, itâ€™s not great. We end up with many nested callback functions that are dependent on the previous callback function. This is often referred to as a <a target="_blank" rel="noopener" href="http://callbackhell.com/"><em>callback hell</em></a>, as we end up with tons of nested callback functions that make the code quite difficult to read!</p>
<blockquote>
<p>å—¯â€¦â€¦ æ³¨æ„åˆ°è¿™é‡Œæœ‰ä»€ä¹ˆå—ï¼Ÿè™½ç„¶â€¦â€¦ è¿˜å¥½ï¼Œä½†ä¸æ˜¯å¾ˆå¥½ã€‚æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†è®¸å¤šä¾èµ–äºå‰ä¸€ä¸ªå›è°ƒå‡½æ•°çš„åµŒå¥—å›è°ƒå‡½æ•°ã€‚è¿™é€šå¸¸è¢«ç§°ä¸ºå›è°ƒåœ°ç‹±ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°å¤§é‡åµŒå¥—çš„å›è°ƒå‡½æ•°ï¼Œè¿™ä½¿å¾—ä»£ç å¾ˆéš¾é˜…è¯»ï¼</p>
</blockquote>
<p>Luckily, we now got something called <strong>promises</strong> to help us out! Letâ€™s take a look at what promises are, and how they can help us in situations like these! ğŸ˜ƒ</p>
<blockquote>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªå«åš promises çš„ä¸œè¥¿æ¥å¸®åŠ©æˆ‘ä»¬ï¼è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Promise æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•åœ¨è¿™æ ·çš„æƒ…å†µä¸‹å¸®åŠ©æˆ‘ä»¬ï¼ ğŸ˜ƒ</p>
</blockquote>
<hr>
<h3 id="Promise-Syntax"><a href="#Promise-Syntax" class="headerlink" title="Promise Syntax"></a>Promise Syntax</h3><p>ES6 introduced <strong>Promises</strong>. In many tutorials, youâ€™ll read something like:</p>
<blockquote>
<p>â€œA promise is a placeholder for a value that can either resolve or reject at some time in the futureâ€</p>
</blockquote>
<p>Yeahâ€¦ That explanation never made things clearer for me. In fact it only made me feel like a Promise was a weird, vague, unpredictable piece of magic. So letâ€™s look at what promises <em>really</em> are.</p>
<p>We can create a promise, using a <code>Promise</code> constructor that receives a callback. Okay cool, letâ€™s try it out!</p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª promiseï¼Œä½¿ç”¨ä¸€ä¸ªæ¥æ”¶å›è°ƒçš„ Promise æ„é€ å‡½æ•°ã€‚ä¸é”™ï¼Œå¿«æ¥è¯•è¯•å§ï¼</p>
</blockquote>
<p><img src="/images/79zi452hphe7ecylhozy.gif"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Promise &#123;&lt;pending>&#125;</span>
<span class="token comment">// __proto__: Promise</span>
<span class="token comment">// [[PromiseState]]: "pending"</span>
<span class="token comment">// [[PromiseResult]]: undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Wait woah, what just got returned?</p>
<p>A <code>Promise</code> is an object that contains a <strong>status</strong>, (<code>[[PromiseStatus]]</code>) and a <strong>value</strong> (<code>[[PromiseValue]]</code>). In the above example, you can see that the value of <code>[[PromiseStatus]]</code> is <code>&quot;pending&quot;</code>, and the value of the promise is <code>undefined</code>.</p>
<blockquote>
<p><code>Promise</code> æ˜¯ä¸€ä¸ªåŒ…å«çŠ¶æ€ (<code>[[PromiseStatus]]</code>) å’Œå€¼ (<code>[[PromiseValue]]</code>) çš„å¯¹è±¡ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>[[PromiseStatus]]</code> çš„å€¼ä¸º <code>&quot;pending&quot;</code>ï¼Œpromise çš„å€¼ä¸º <code>undefined</code>ã€‚</p>
</blockquote>
<p>Donâ€™t worry - youâ€™ll never have to interact with this object, you canâ€™t even access the <code>[[PromiseStatus]]</code> and <code>[[PromiseValue]]</code> properties! However, the values of these properties are important when working with promises.</p>
<blockquote>
<p>åˆ«æ‹…å¿ƒ - ä½ æ°¸è¿œä¸å¿…ä¸è¿™ä¸ªå¯¹è±¡æ‰“äº¤é“ï¼Œä½ ç”šè‡³ä¸èƒ½è®¿é—® <code>[[PromiseStatus]]</code> å’Œ <code>[[PromiseValue]]</code> å±æ€§ï¼ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ Promise æ—¶ï¼Œè¿™äº›å±æ€§çš„å€¼å¾ˆé‡è¦ã€‚</p>
</blockquote>
<hr>
<p>The value of the <code>PromiseStatus</code>, the <strong>state</strong>, can be one of three values:</p>
<ul>
<li>âœ… <code>fulfilled</code>: The promise has been <code>resolved</code>. Everything went fine, no errors occurred within the promise ğŸ¥³</li>
<li>âŒ <code>rejected</code> : The promise has been <code>rejected</code>. Argh, something went wrong..</li>
<li>â³ <code>pending</code>: The promise has neither resolved nor rejected (yet), the promise is still <code>pending</code>.</li>
</ul>
<p>Alright this all sounds great, but <em>when</em> is a promise status <code>&quot;pending&quot;</code>, <code>&quot;fulfilled&quot;</code> or <code>&quot;rejected&quot;</code>? And why does that status even matter?</p>
<blockquote>
<p>å¥½å§ï¼Œè¿™ä¸€åˆ‡å¬èµ·æ¥éƒ½ä¸é”™ï¼Œä½†æ˜¯æ‰¿è¯ºçŠ¶æ€ä½•æ—¶æ˜¯ â€œå¾…å®šâ€ã€â€œå·²å®ç°â€ æˆ– â€œå·²æ‹’ç»â€ï¼Ÿä¸ºä»€ä¹ˆè¿™ç§çŠ¶æ€å¾ˆé‡è¦ï¼Ÿ</p>
</blockquote>
<p>In the above example, we just passed the simple callback function <code>() =&gt; &#123;&#125;</code> to the <code>Promise</code> constructor. However, this callback function actually receives two arguments. The value of the first argument, often called <code>resolve</code> or <code>res</code>, is the method to be called when the Promise should <strong>resolve</strong>. The value of the second argument, often called <code>reject</code> or <code>rej</code>, is the value method to be called when the Promise should <strong>reject</strong>, something went wrong.</p>
<blockquote>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å°†ç®€å•çš„å›è°ƒå‡½æ•° <code>() =&gt; &#123;&#125;</code> ä¼ é€’ç»™äº† <code>Promise</code> æ„é€ å‡½æ•°ã€‚ç„¶è€Œï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å®é™…ä¸Šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œé€šå¸¸ç§°ä¸º <code>resolve</code> æˆ– <code>res</code>ï¼Œæ˜¯ Promise åº”è¯¥è§£ææ—¶è¦è°ƒç”¨çš„æ–¹æ³•ã€‚ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ï¼Œé€šå¸¸ç§°ä¸º <code>reject</code> æˆ– <code>rej</code>ï¼Œæ˜¯å½“ Promise åº”è¯¥æ‹’ç»æ—¶è°ƒç”¨çš„å€¼æ–¹æ³•ï¼Œå‡ºç°é—®é¢˜ã€‚</p>
</blockquote>
<p><img src="/images/duen4peq0bdr55cka5ya.png"></p>
<p>Letâ€™s try and see that gets logged when we invoke either the <code>resolve</code> or <code>reject</code> method! In my example, I called the <code>resolve</code> method <code>res</code>, and the <code>reject</code> method <code>rej</code>.</p>
<blockquote>
<p>è®©æˆ‘ä»¬è¯•ç€çœ‹çœ‹å½“æˆ‘ä»¬è°ƒç”¨ <code>resolve</code> æˆ– <code>reject</code> æ–¹æ³•æ—¶ä¼šè¢«è®°å½•ä¸‹æ¥ï¼åœ¨æˆ‘çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘è°ƒç”¨äº†è§£ææ–¹æ³• <code>res</code> å’Œæ‹’ç»æ–¹æ³• <code>rej</code>ã€‚</p>
</blockquote>
<p><img src="/images/z0b9v0h7aiq073l5tl2l.gif"></p>
<p>Awesome! We finally know how to get rid of the <code>&quot;pending&quot;</code> status and the <code>undefined</code> value! The <strong>status</strong> of a promise is <code>&quot;fulfilled&quot;</code> if we invoked the <code>resolve</code> method, and the status of the promise is <code>&quot;rejected</code>â€œ if we invoked the <code>rejected</code> method.</p>
<blockquote>
<p>æƒŠäººçš„ï¼æˆ‘ä»¬ç»ˆäºçŸ¥é“å¦‚ä½•æ‘†è„± <code>&quot;pending&quot;</code> çŠ¶æ€å’Œ <code>undefined</code> å€¼äº†ï¼å¦‚æœæˆ‘ä»¬è°ƒç”¨äº† <code>resolve</code> æ–¹æ³•ï¼Œpromise çš„çŠ¶æ€å°±æ˜¯ <code>&quot;fulfilled&quot;</code> ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨äº† <code>rejected</code> æ–¹æ³•ï¼Œpromise çš„çŠ¶æ€å°±æ˜¯ <code>&quot;rejected</code>â€œã€‚</p>
</blockquote>
<p>The <strong>value</strong> of a promise, the value of <code>[[PromiseValue]]</code>, is the value that we pass to the either the <code>resolved</code> or <code>rejected</code> method as their argument.</p>
<blockquote>
<p>ä¸€ä¸ª promise çš„å€¼ï¼Œå³ <code>[[PromiseValue]]</code> çš„å€¼ï¼Œæ˜¯æˆ‘ä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>resolved</code> æˆ– <code>rejected</code> æ–¹æ³•çš„å€¼ã€‚</p>
</blockquote>
<blockquote>
<p>Fun fact, I let Jake Archibald proofread this article and he actually pointed out thereâ€™s a bug in Chrome that currently shows the status as <code>&quot;resolved&quot;</code> instead of <code>&quot;fulfilled&quot;</code>. Thanks to <a target="_blank" rel="noopener" href="https://twitter.com/mathias">Mathias Bynens</a> itâ€™s now fixed in Canary! ğŸ¥³ğŸ•ºğŸ¼</p>
<p><img src="https://pbs.twimg.com/media/EVJqgKLUwAEocsG.png" alt="unknown tweet media content"></p>
<p>Chrome and Safari call this a â€œresolvedâ€ promise, which is true, but kinda misleadingâ€¦</p>
</blockquote>
<hr>
<p>Okay so, now we know a little bit better how to control that vague <code>Promise</code> object. But what is it used for?</p>
<blockquote>
<p>å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å¯¹å¦‚ä½•æ§åˆ¶é‚£ä¸ªæ¨¡ç³Šçš„ <code>Promise</code> å¯¹è±¡æœ‰äº†æ›´å¥½çš„äº†è§£ã€‚ä½†æ˜¯å®ƒæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
</blockquote>
<p>In the introductory section, I showed an example in which we get an image, compress it, apply a filer, and save it! Eventually, this ended up being a nested callback mess.</p>
<blockquote>
<p>åœ¨ä»‹ç»éƒ¨åˆ†ï¼Œæˆ‘å±•ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼Œå…¶ä¸­æˆ‘ä»¬è·å–å›¾åƒã€å‹ç¼©å®ƒã€åº”ç”¨æ–‡ä»¶ç®¡ç†å™¨å¹¶ä¿å­˜å®ƒï¼æœ€ç»ˆï¼Œè¿™æœ€ç»ˆæˆä¸ºä¸€ä¸ªåµŒå¥—çš„å›è°ƒæ··ä¹±ã€‚</p>
</blockquote>
<p>Luckily, Promises can help us fix this! First, letâ€™s rewrite the entire code block, so that each function returns a <code>Promise</code> instead.</p>
<blockquote>
<p>å¹¸è¿çš„æ˜¯ï¼ŒPromises å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼é¦–å…ˆï¼Œè®©æˆ‘ä»¬é‡å†™æ•´ä¸ªä»£ç å—ï¼Œè®©æ¯ä¸ªå‡½æ•°éƒ½è¿”å›ä¸€ä¸ª Promiseã€‚</p>
</blockquote>
<p>If the image is loaded and everything went fine, letâ€™s <strong>resolve</strong> the promise with the loaded image! Else, if there was an error somewhere while loading the file, letâ€™s <strong>reject</strong> the promise with the error that occurred.</p>
<blockquote>
<p>å¦‚æœå›¾åƒå·²åŠ è½½å¹¶ä¸”ä¸€åˆ‡æ­£å¸¸ï¼Œè®©æˆ‘ä»¬ç”¨åŠ è½½çš„å›¾åƒè§£å†³ promiseï¼å¦åˆ™ï¼Œå¦‚æœåœ¨åŠ è½½æ–‡ä»¶æ—¶æŸå¤„å‡ºç°é”™è¯¯ï¼Œè®©æˆ‘ä»¬æ‹’ç»å‘ç”Ÿé”™è¯¯çš„æ‰¿è¯ºã€‚</p>
</blockquote>
<p><img src="/images/iebp0rzfnfqsrmmjplme.png"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getImage</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rs<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Letâ€™s see what happens when we run this in the terminal!</p>
<p><img src="/images/wsu5nn26dp4elcwh764m.gif"></p>
<p>Cool! A promise got returned with the value of the parsed data, just like we expected.</p>
<blockquote>
<p>å‡‰çˆ½çš„ï¼æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œä¸€ä¸ªå¸¦æœ‰è§£ææ•°æ®å€¼çš„æ‰¿è¯ºè¢«è¿”å›ã€‚</p>
</blockquote>
<p>Butâ€¦ what now? We donâ€™t care about that entire promise object, we only care about the value of the data! Luckily, there are built-in methods to get a promiseâ€™s value. To a promise, we can attach 3 methods:</p>
<blockquote>
<p>ä½†æ˜¯â€¦â€¦ç°åœ¨æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬ä¸å…³å¿ƒæ•´ä¸ª promise å¯¹è±¡ï¼Œæˆ‘ä»¬åªå…³å¿ƒæ•°æ®çš„ä»·å€¼ï¼å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€äº›å†…ç½®æ–¹æ³•å¯ä»¥è·å– Promise çš„å€¼ã€‚å¯¹äº promiseï¼Œæˆ‘ä»¬å¯ä»¥é™„åŠ  3 ä¸ªæ–¹æ³•ï¼š</p>
</blockquote>
<ul>
<li><code>.then()</code>: Gets called after a promise <em>resolved</em>.</li>
<li><code>.catch()</code>: Gets called after a promise <em>rejected</em>.</li>
<li><code>.finally()</code>: <em>Always</em> gets called, whether the promise resolved or rejected.</li>
</ul>
<p><img src="/images/mu1aqqnyfjsfon5hwrtw.png"></p>
<p>The <code>.then</code> method receives the value passed to the <code>resolve</code> method.</p>
<p><img src="/images/11vxhn9cun7stpjbdi80.gif"></p>
<p>The <code>.catch</code> method receives the value passed to the <code>rejected</code> method</p>
<p><img src="/images/v5y24jz4u89flazvdyn4.gif"></p>
<p>Finally, we have the value that got resolved by the promise without having that entire promise object! We can now do whatever we want with this value.</p>
<blockquote>
<p>æœ€åï¼Œæˆ‘ä»¬æœ‰äº†ç”± Promise è§£æçš„å€¼ï¼Œè€Œæ²¡æœ‰æ•´ä¸ª Promise å¯¹è±¡ï¼æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨è¿™ä¸ªå€¼åšä»»ä½•æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ã€‚</p>
</blockquote>
<hr>
<p>FYI, when you know that a promise will always resolve or always reject, you can write <code>Promise.resolve</code> or <code>Promise.reject</code> , with the value you want to reject or resolve the promise with!</p>
<blockquote>
<p>ä»…ä¾›å‚è€ƒï¼Œå½“æ‚¨çŸ¥é“æ‰¿è¯ºå°†å§‹ç»ˆè§£å†³æˆ–å§‹ç»ˆæ‹’ç»æ—¶ï¼Œæ‚¨å¯ä»¥ç¼–å†™ <code>Promise.resolve</code> æˆ– <code>Promise.reject</code>ï¼Œå¹¶ä½¿ç”¨æ‚¨æƒ³è¦æ‹’ç»æˆ–è§£å†³æ‰¿è¯ºçš„å€¼ï¼</p>
</blockquote>
<p><img src="/images/90hxwjfadzslvdbkr4l8.png"></p>
<p>Youâ€™ll often see this syntax in the following examples ğŸ˜„</p>
<hr>
<p>In the <code>getImage</code> example, we ended up having to nest multiple callbacks in order to run them. Luckily, the <code>.then</code> handlers can help us with that! ğŸ¥³</p>
<blockquote>
<p>åœ¨ <code>getImage</code> ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆä¸å¾—ä¸åµŒå¥—å¤šä¸ªå›è°ƒä»¥è¿è¡Œå®ƒä»¬ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<code>.then </code>å¤„ç†ç¨‹åºå¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼ ğŸ¥³</p>
</blockquote>
<p>The result of the <code>.then</code> itself is a promise value. This means that we can chain as many <code>.then</code>s as we want: the result of the previous <code>then</code> callback will be passed as an argument to the next <code>then</code> callback!</p>
<blockquote>
<p><code>.then</code> æœ¬èº«çš„ç»“æœæ˜¯ä¸€ä¸ª promise å€¼ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é“¾æ¥ä»»æ„æ•°é‡çš„ <code>.then</code>ï¼šå‰ä¸€ä¸ª then å›è°ƒçš„ç»“æœå°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸€ä¸ª <code>then</code> å›è°ƒï¼</p>
</blockquote>
<p><img src="/images/i6busbetmoya9vny2eku.png"></p>
<p>In the case of the <code>getImage</code> example, we can chain multiple <code>then</code> callbacks in order to pass the processed image onto the next function! Instead of ending up with many nested callbacks, we get a clean <code>then</code> chain.</p>
<blockquote>
<p>åœ¨ <code>getImage</code> ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é“¾æ¥å¤šä¸ª <code>then</code> å›è°ƒï¼Œä»¥ä¾¿å°†å¤„ç†åçš„å›¾åƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªå‡½æ•°ï¼æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå¹²å‡€çš„ <code>then</code> é“¾ï¼Œè€Œä¸æ˜¯ä»¥è®¸å¤šåµŒå¥—çš„å›è°ƒç»“æŸã€‚</p>
</blockquote>
<p><img src="/images/u9l3lxwxlxgv2edv79xh.png" alt="Promise ç‰ˆæœ¬çš„ getImage"></p>
<p>Perfect! This syntax already looks way better than the nested callbacks.</p>
<blockquote>
<p>å®Œç¾çš„ï¼è¿™ç§è¯­æ³•çœ‹èµ·æ¥æ¯”åµŒå¥—å›è°ƒæ›´å¥½ã€‚</p>
</blockquote>
<hr>
<h2 id="Microtasks-and-Macro-tasks"><a href="#Microtasks-and-Macro-tasks" class="headerlink" title="Microtasks and (Macro)tasks"></a>Microtasks and (Macro)tasks</h2><blockquote>
<p>å¾®ä»»åŠ¡å’Œï¼ˆå®ï¼‰ä»»åŠ¡</p>
</blockquote>
<p>Okay so we know a little better how to create a promise and how to extract values out of a promise. Letâ€™s add some more code to the script, and run it again:</p>
<blockquote>
<p>å¥½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å¦‚ä½•åˆ›å»ºæ‰¿è¯ºä»¥åŠå¦‚ä½•ä»æ‰¿è¯ºä¸­æå–å€¼æœ‰äº†æ›´å¥½çš„äº†è§£ã€‚è®©æˆ‘ä»¬å‘è„šæœ¬æ·»åŠ æ›´å¤šä»£ç ï¼Œç„¶åå†æ¬¡è¿è¡Œå®ƒï¼š</p>
</blockquote>
<p><img src="/images/ey4ubnv5yjgi6hbh97xq.gif"></p>
<p>Wait what?! ğŸ¤¯</p>
<p>First, <code>Start!</code> got logged. Okay we couldâ€™ve seen that one coming: <code>console.log(&#39;Start!&#39;)</code> is on the very first line! However, the second value that got logged was <code>End!</code>, and <em>not</em> the value of the resolved promise! Only after <code>End!</code> was logged, the value of the promise got logged. Whatâ€™s going on here?</p>
<blockquote>
<p>é¦–å…ˆï¼Œ<code>Start!</code>è¢«ç™»å½•äº†ã€‚å¥½å§ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼š<code>console.log(&#39;Start!&#39;)</code> åœ¨ç¬¬ä¸€è¡Œï¼ä½†æ˜¯ï¼Œè®°å½•çš„ç¬¬äºŒä¸ªå€¼æ˜¯ <code>End!</code>ï¼Œè€Œä¸æ˜¯å·²è§£å†³çš„ Promise çš„å€¼ï¼åªæœ‰ <code>End!</code> è¢«è®°å½•ï¼Œpromise çš„å€¼è¢«è®°å½•ã€‚è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<p>Weâ€™ve finally seen the true power of promises! ğŸš€ Although JavaScript is single-threaded, we can add asynchronous behavior using a <code>Promise</code>!</p>
<blockquote>
<p>æˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº† Promise çš„çœŸæ­£åŠ›é‡ï¼ ğŸš€ è™½ç„¶ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Promise æ·»åŠ å¼‚æ­¥è¡Œä¸ºï¼</p>
</blockquote>
<hr>
<p>But wait, havenâ€™t we seen that before? ğŸ¤” In the <a target="_blank" rel="noopener" href="https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif">JavaScript event loop</a>, canâ€™t we also use methods native to the browser such as <code>setTimeout</code> to create some sort of asynchronous behavior?</p>
<blockquote>
<p>ä½†æ˜¯ç­‰ç­‰ï¼Œæˆ‘ä»¬ä»¥å‰æ²¡è§è¿‡å—ï¼Ÿ ğŸ¤” åœ¨ JavaScript äº‹ä»¶å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ä¹Ÿä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„æ–¹æ³•ï¼Œä¾‹å¦‚ <code>setTimeout</code> æ¥åˆ›å»ºæŸç§å¼‚æ­¥è¡Œä¸ºå—ï¼Ÿ</p>
</blockquote>
<p>Yes! However, within the Event Loop, there are actually two types of queues: the <strong>(macro)task queue</strong> (or just called the <strong>task queue</strong>), and the <strong>microtask queue</strong>. The (macro)task queue is for <strong>(macro)tasks</strong> and the microtask queue is for <strong>microtasks</strong>.</p>
<blockquote>
<p>æ˜¯çš„ï¼ç„¶è€Œï¼Œåœ¨äº‹ä»¶å¾ªç¯å†…éƒ¨ï¼Œå®é™…ä¸Šæœ‰ä¸¤ç§ç±»å‹çš„é˜Ÿåˆ—ï¼šï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæˆ–ç®€ç§°ä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼‰å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚ ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—ç”¨äºï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ç”¨äºå¾®ä»»åŠ¡ã€‚</p>
</blockquote>
<p>So whatâ€™s a <em>(macro)task</em> and whatâ€™s a <em>microtask</em>? Although there are a few more than Iâ€™ll cover here, the most common are shown in the table below!</p>
<blockquote>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯ï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œä»€ä¹ˆæ˜¯å¾®ä»»åŠ¡ï¼Ÿè™½ç„¶æœ‰ä¸€äº›æ¯”æˆ‘åœ¨è¿™é‡Œä»‹ç»çš„è¦å¤šï¼Œä½†æœ€å¸¸è§çš„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>(Macro)task</td>
<td><code>setTimeout</code></td>
<td><code>setInterval</code></td>
<td><code>setImmediate</code></td>
</tr>
<tr>
<td>Microtask</td>
<td><code>process.nextTick</code></td>
<td><code>Promise callback</code></td>
<td><code>queueMicrotask</code></td>
</tr>
</tbody></table>
<p>Ahh, we see <code>Promise</code> in the microtask list! ğŸ˜ƒ When a <code>Promise</code> resolves and calls its <code>then()</code>, <code>catch()</code> or <code>finally()</code>, method, the callback within the method gets added to the <strong>microtask queue</strong>! This means that the callback within the <code>then()</code>, <code>catch()</code> or <code>finally()</code> method isnâ€™t executed immediately, essentially adding some async behavior to our JavaScript code!</p>
<blockquote>
<p>å•Šï¼Œæˆ‘ä»¬åœ¨å¾®ä»»åŠ¡åˆ—è¡¨ä¸­çœ‹åˆ°äº† Promiseï¼ ğŸ˜ƒ å½“ Promise è§£æå¹¶è°ƒç”¨å…¶ <code>then()</code>ã€<code>catch()</code> æˆ– <code>finally()</code> æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¸­çš„å›è°ƒä¼šè¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼è¿™æ„å‘³ç€ <code>then()</code>ã€<code>catch()</code> æˆ– <code>finally()</code> æ–¹æ³•ä¸­çš„å›è°ƒä¸ä¼šç«‹å³æ‰§è¡Œï¼Œå®è´¨ä¸Šæ˜¯å‘æˆ‘ä»¬çš„ JavaScript ä»£ç æ·»åŠ äº†ä¸€äº›å¼‚æ­¥è¡Œä¸ºï¼</p>
</blockquote>
<p>So when <em>is</em> a <code>then()</code>, <code>catch()</code> or <code>finally()</code> callback executed? The event loop gives a different priority to the tasks:</p>
<blockquote>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ‰§è¡Œ <code>then()</code>ã€<code>catch()</code> æˆ– <code>finally()</code> å›è°ƒï¼Ÿäº‹ä»¶å¾ªç¯ä¸ºä»»åŠ¡èµ‹äºˆä¸åŒçš„ä¼˜å…ˆçº§ï¼š</p>
</blockquote>
<ol>
<li>All functions in that are currently in the <strong>call stack</strong> get executed. When they returned a value, they get popped off the stack.</li>
<li>When the call stack is empty, <em>all</em> queued up <strong>microtasks</strong> are popped onto the callstack one by one, and get executed! (Microtasks themselves can also return new microtasks, effectively creating an infinite microtask loop ğŸ˜¬)</li>
<li>If both the call stack and microtask queue are empty, the event loop checks if there are tasks left on the (macro)task queue. The tasks get popped onto the callstack, executed, and popped off!</li>
</ol>
<blockquote>
<ul>
<li>å½“å‰åœ¨è°ƒç”¨å †æ ˆä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½å°†æ‰§è¡Œ. å½“å®ƒä»¬è¿”å›ä¸€ä¸ªå€¼æ—¶, å®ƒä»¬å°±ä¼šä»å †æ ˆä¸­å¼¹å‡º.</li>
<li>å½“è°ƒç”¨å †æ ˆä¸ºç©ºæ—¶, æ‰€æœ‰æ’é˜Ÿçš„å¾®ä»»åŠ¡éƒ½ä¼šä¸€ä¸€å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸Š, ç„¶åæ‰§è¡Œï¼(å¾®ä»»åŠ¡æœ¬èº«ä¹Ÿå¯ä»¥è¿”å›æ–°çš„å¾®ä»»åŠ¡, ä»è€Œæœ‰æ•ˆåœ°åˆ›å»ºæ— é™çš„å¾®ä»»åŠ¡å¾ªç¯ loop)</li>
<li>å¦‚æœè°ƒç”¨å †æ ˆå’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©º, åˆ™äº‹ä»¶å¾ªç¯å°†æ£€æŸ¥ (å®) ä»»åŠ¡é˜Ÿåˆ—ä¸Šæ˜¯å¦è¿˜æœ‰ä»»åŠ¡. ä»»åŠ¡è¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸Š, æ‰§è¡Œå¹¶å¼¹å‡ºï¼</li>
</ul>
</blockquote>
<hr>
<p>Letâ€™s take a look at a quick example, simply using:</p>
<ul>
<li><code>Task1</code>: a function thatâ€™s added to the call stack immediately, for example by invoking it instantly in our code.</li>
<li><code>Task2</code>, <code>Task3</code>, <code>Task4</code>: microtasks, for example a promise <code>then</code> callback, or a task added with <code>queueMicrotask</code>.</li>
<li><code>Task5</code>, <code>Task6</code>: a (macro)task, for example a <code>setTimeout</code> or <code>setImmediate</code> callback</li>
</ul>
<p><img src="/images/42eatw03fcha0e1qcrf0.gif"></p>
<p>First, <code>Task1</code> returned a value and got popped off the call stack. Then, the engine checked for tasks queued in the microtask queue. Once all the tasks were put on the call stack and eventually popped off, the engine checked for tasks on the (macro)task queue, which got popped onto the call stack, and popped off when they returned a value.</p>
<blockquote>
<p>é¦–å…ˆï¼Œ<code>Task1</code> è¿”å›ä¸€ä¸ªå€¼å¹¶ä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºã€‚ç„¶åï¼Œå¼•æ“æ£€æŸ¥åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿçš„ä»»åŠ¡ã€‚ä¸€æ—¦æ‰€æœ‰ä»»åŠ¡éƒ½è¢«æ”¾å…¥è°ƒç”¨å †æ ˆå¹¶æœ€ç»ˆå¼¹å‡ºï¼Œå¼•æ“å°±ä¼šæ£€æŸ¥ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡è¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œå¹¶åœ¨å®ƒä»¬è¿”å›å€¼æ—¶å¼¹å‡ºã€‚</p>
</blockquote>
<p>Okay okay enough pink boxes. Letâ€™s use it with some real code!</p>
<p><img src="/images/g61wwyi8wchk2hpzeq4u.png"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Start!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Timeout!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise!'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'End!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//> "Start!"</span>
<span class="token comment">//> "End!"</span>
<span class="token comment">//> "Promise!"</span>
<span class="token comment">//> "Timeout!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In this code, we have the macro task <code>setTimeout</code>, and the microtask promise <code>then()</code> callback. Once the engine reaches the line of the <code>setTimeout</code> function. Letâ€™s run this code step-by-step, and see what gets logged!</p>
<blockquote>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æœ‰å®ä»»åŠ¡ <code>setTimeout</code> å’Œå¾®ä»»åŠ¡ promise <code>then()</code> å›è°ƒã€‚ä¸€æ—¦å¼•æ“åˆ°è¾¾ <code>setTimeout</code> å‡½æ•°çš„è¡Œã€‚è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°è¿è¡Œè¿™æ®µä»£ç ï¼Œçœ‹çœ‹è®°å½•äº†ä»€ä¹ˆï¼</p>
</blockquote>
<hr>
<blockquote>
<p>Quick FYI - in the following examples Iâ€™m showing methods like <code>console.log</code>, <code>setTimeout</code> and <code>Promise.resolve</code> being added to the call stack. Theyâ€™re internal methods and actually donâ€™t appear in stack traces - so donâ€™t worry if youâ€™re using the debugger and you donâ€™t see them anywhere! It just makes explaining this concept easier without adding a bunch of boilerplate code ğŸ™‚</p>
</blockquote>
<blockquote>
<p>å¿«é€Ÿå‚è€ƒ - åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†å±•ç¤ºè¯¸å¦‚ <code>console.log</code>ã€<code>setTimeout</code> å’Œ <code>Promise.resolve</code> ä¹‹ç±»çš„æ–¹æ³•è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ã€‚å®ƒä»¬æ˜¯å†…éƒ¨æ–¹æ³•ï¼Œå®é™…ä¸Šä¸ä¼šå‡ºç°åœ¨å †æ ˆè·Ÿè¸ªä¸­ - æ‰€ä»¥å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨è°ƒè¯•å™¨å¹¶ä¸”åœ¨ä»»ä½•åœ°æ–¹éƒ½çœ‹ä¸åˆ°å®ƒä»¬ï¼Œè¯·ä¸è¦æ‹…å¿ƒï¼å®ƒåªæ˜¯ä½¿è§£é‡Šè¿™ä¸ªæ¦‚å¿µæ›´å®¹æ˜“ï¼Œè€Œæ— éœ€æ·»åŠ ä¸€å †æ ·æ¿ä»£ç  ğŸ™‚</p>
</blockquote>
<p>On the first line, the engine encounters the <code>console.log()</code> method. It gets added to the call stack, after which it logs the value <code>Start!</code> to the console. The method gets popped off the call stack, and the engine continues.</p>
<blockquote>
<p>åœ¨ç¬¬ä¸€è¡Œï¼Œå¼•æ“é‡åˆ°äº† <code>console.log()</code> æ–¹æ³•ã€‚å®ƒè¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œä¹‹åå®ƒä¼šè®°å½•å€¼ <code>Start!</code> åˆ°æ§åˆ¶å°ã€‚è¯¥æ–¹æ³•ä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºï¼Œå¼•æ“ç»§ç»­ã€‚</p>
</blockquote>
<p><img src="/images/6cbjuexvy6z9ltk0bi18.gif"></p>
<p>The engine encounters the <code>setTimeout</code> method, which gets popped on to the call stack. The <code>setTimeout</code> method is native to the browser: its callback function (<code>() =&gt; console.log(&#39;In timeout&#39;)</code>) will get added to the Web API, until the timer is done. Although we provided the value <code>0</code> for the timer, the call back still gets pushed to the Web API first, after which it gets added to the <strong>(macro)task queue</strong>: <code>setTimeout</code> is a macro task!</p>
<blockquote>
<p>å¼•æ“é‡åˆ° <code>setTimeout</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ã€‚ <code>setTimeout</code> æ–¹æ³•æ˜¯æµè§ˆå™¨æœ¬æœºçš„ï¼šå®ƒçš„å›è°ƒå‡½æ•° <code>(() =&gt; console.log(&#39;In timeout&#39;))</code> å°†è¢«æ·»åŠ åˆ° Web APIï¼Œç›´åˆ°è®¡æ—¶å™¨å®Œæˆã€‚å°½ç®¡æˆ‘ä»¬ä¸ºè®¡æ—¶å™¨æä¾›äº†å€¼ <code>0</code>ï¼Œä½†å›è°ƒä»ç„¶é¦–å…ˆè¢«æ¨é€åˆ° Web APIï¼Œç„¶åå®ƒä¼šè¢«æ·»åŠ åˆ°ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š<code>setTimeout </code>æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼</p>
</blockquote>
<p><img src="/images/yqoemb6f32lvovge8yrp.gif"></p>
<hr>
<p>The engine encounters the <code>Promise.resolve()</code> method. The <code>Promise.resolve()</code> method gets added to the call stack, after which is resolves with the value <code>Promise!</code>. Its <code>then</code> callback function gets added to the <strong>microtask queue</strong>.</p>
<blockquote>
<p>å¼•æ“é‡åˆ°äº† <code>Promise.resolve()</code> æ–¹æ³•ã€‚ <code>Promise.resolve()</code> æ–¹æ³•è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œä¹‹åä½¿ç”¨å€¼ <code>Promise!</code> è§£æã€‚å®ƒçš„ <code>then</code> å›è°ƒå‡½æ•°è¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</p>
</blockquote>
<p><img src="/images/6wxjxduh62fqt531e2rc.gif"></p>
<hr>
<p>The engine encounters the <code>console.log()</code> method. It gets added to the call stack immediately, after which it logs the value <code>End!</code> to the console, gets popped off the call stack, and the engine continues.</p>
<blockquote>
<p>å¼•æ“é‡åˆ°äº† <code>console.log()</code> æ–¹æ³•ã€‚å®ƒä¼šç«‹å³æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œç„¶åè®°å½•å€¼ <code>Endï¼</code> åˆ°æ§åˆ¶å°ï¼Œä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºï¼Œç„¶åå¼•æ“ç»§ç»­ã€‚</p>
</blockquote>
<p><img src="/images/a6jk0exl137yka3oq9k4.gif"></p>
<p>The engine sees the callstack is empty now. Since the call stack is empty, itâ€™s going to check whether there are queued tasks in the <strong>microtask queue</strong>! And yes there are, the promise <code>then</code> callback is waiting for its turn! It gets popped onto the call stack, after which it logs the resolved value of the promise: the string <code>Promise!</code>in this case.</p>
<blockquote>
<p>å¼•æ“ç°åœ¨çœ‹åˆ°è°ƒç”¨å †æ ˆæ˜¯ç©ºçš„ã€‚ç”±äºè°ƒç”¨æ ˆæ˜¯ç©ºçš„ï¼Œå®ƒä¼šæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ’é˜Ÿçš„ä»»åŠ¡ï¼æ˜¯çš„ï¼Œæ‰¿è¯º<code>then</code> å›è°ƒæ­£åœ¨ç­‰å¾…è½®åˆ°å®ƒï¼å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œä¹‹åå®ƒä¼šè®°å½•æ‰¿è¯ºçš„è§£æå€¼ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å­—ç¬¦ä¸² <code>Promise!</code>ã€‚</p>
</blockquote>
<p><img src="/images/lczn4fca41is4vpicr6w.gif"></p>
<p>The engine sees the call stack is empty, so itâ€™s going to check the microtask queue once again to see if tasks are queued. Nope, the microtask queue is all empty.</p>
<blockquote>
<p>å¼•æ“çœ‹åˆ°è°ƒç”¨å †æ ˆæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥å®ƒä¼šå†æ¬¡æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä»¥æŸ¥çœ‹ä»»åŠ¡æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ã€‚ä¸ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—å…¨æ˜¯ç©ºçš„ã€‚</p>
</blockquote>
<p>Itâ€™s time to check the <strong>(macro)task queue</strong>: the <code>setTimeout</code> callback is still waiting there! The <code>setTimeout</code> callback gets popped on to the callstack. The callback function returns the <code>console.log</code> method, which logs the string <del><code>&quot;In timeout!&quot;</code></del> <code>&quot;Timeout!&quot;</code>. The <code>setTimeout</code> callback get popped off the callstack.</p>
<blockquote>
<p>æ˜¯æ—¶å€™æ£€æŸ¥ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—äº†ï¼š<code>setTimeout</code> å›è°ƒä»åœ¨é‚£é‡Œç­‰å¾…ï¼ <code>setTimeout</code> å›è°ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆã€‚å›è°ƒå‡½æ•°è¿”å› <code>console.log</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è®°å½•å­—ç¬¦ä¸² <del><code>&quot;In timeout!&quot;</code></del> <code>&quot;Timeout!&quot;</code>ã€‚ <code>setTimeout</code> å›è°ƒä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºã€‚</p>
</blockquote>
<p><img src="/images/p54casaaz9oq0g8ztpi5.gif"></p>
<p>Finally, all done! ğŸ¥³ It seems like the output we saw earlier wasnâ€™t so unexpected after all.</p>
<blockquote>
<p>æœ€åï¼Œä¸€åˆ‡éƒ½å®Œæˆäº†ï¼ ğŸ¥³ çœ‹æ¥æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„è¾“å‡ºæ¯•ç«Ÿä¸æ˜¯é‚£ä¹ˆå‡ºäººæ„æ–™ã€‚</p>
</blockquote>
<hr>
<h2 id="Async-Await"><a href="#Async-Await" class="headerlink" title="Async/Await"></a>Async/Await</h2><p>ES7 introduced a new way to add async behavior in JavaScript and make working with promises easier! With the introduction of the <code>async</code> and <code>await</code> keywords, we can create <strong>async</strong> functions which implicitly return a promise. But.. how can we do that? ğŸ˜®</p>
<blockquote>
<p>ES7 å¼•å…¥äº†ä¸€ç§åœ¨ JavaScript ä¸­æ·»åŠ å¼‚æ­¥è¡Œä¸ºçš„æ–°æ–¹æ³•ï¼Œå¹¶ä½¿ä½¿ç”¨ Promise æ›´å®¹æ˜“ï¼é€šè¿‡å¼•å…¥ <code>async</code> å’Œ <code>await</code> å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºéšå¼è¿”å›æ‰¿è¯ºçš„å¼‚æ­¥å‡½æ•°ã€‚ä½†æ˜¯..æˆ‘ä»¬æ€ä¹ˆèƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ ğŸ˜®</p>
</blockquote>
<p>Previously, we saw that we can explicitly create promises using the <code>Promise</code> object, whether it was by typing <code>new Promise(() =&gt; &#123;&#125;)</code>, <code>Promise.resolve</code>, or <code>Promise.reject</code>.</p>
<blockquote>
<p>ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Promise å¯¹è±¡æ˜¾å¼åˆ›å»º Promiseï¼Œæ— è®ºæ˜¯é€šè¿‡é”®å…¥ <code>new Promise(() =&gt; &#123;&#125;)</code>ã€<code>Promise.resolve</code> è¿˜æ˜¯ <code>Promise.reject</code>ã€‚</p>
</blockquote>
<p>Instead of explicitly using the <code>Promise</code> object, we can now create asynchronous functions that <em>implicitly</em> return an object! This means that we no longer have to write any <code>Promise</code> object ourselves.</p>
<blockquote>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºéšå¼è¿”å›å¯¹è±¡çš„å¼‚æ­¥å‡½æ•°ï¼Œè€Œä¸æ˜¯æ˜¾å¼ä½¿ç”¨ Promise å¯¹è±¡ï¼è¿™æ„å‘³ç€æˆ‘ä»¬ä¸å†éœ€è¦è‡ªå·±ç¼–å†™ä»»ä½• Promise å¯¹è±¡ã€‚</p>
</blockquote>
<p><img src="/images/72lqrcvy9lc8ehbpitd0.png"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> funcion <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string">'Hello!'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Although the fact that <strong>async</strong> functions implicitly return promises is pretty great, the real power of <code>async</code> functions can be seen when using the <code>await</code> keyword! With the <code>await</code> keyword, we can <em>suspend(æš‚åœ)</em> the asynchronous function while we wait for the <code>await</code>ed value return a resolved promise. If we want to get the value of this resolved promise, like we previously did with the <code>then()</code> callback, we can assign variables to the <code>await</code>ed promise value!</p>
<blockquote>
<p>å°½ç®¡ async å‡½æ•°éšå¼è¿”å› promise çš„äº‹å®éå¸¸å¥½ï¼Œä½†æ˜¯ä½¿ç”¨ await å…³é”®å­—æ—¶å¯ä»¥çœ‹åˆ° async å‡½æ•°çš„çœŸæ­£å¨åŠ›ï¼ä½¿ç”¨ await å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥æš‚åœï¼ˆæš‚åœï¼‰å¼‚æ­¥å‡½æ•°ï¼ŒåŒæ—¶ç­‰å¾…ç­‰å¾…çš„å€¼è¿”å›å·²è§£å†³çš„æ‰¿è¯ºã€‚å¦‚æœæˆ‘ä»¬æƒ³è·å¾—è¿™ä¸ªå·²è§£æçš„ promise çš„å€¼ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰å¯¹ then() å›è°ƒæ‰€åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç­‰å¾…çš„ promise å€¼åˆ†é…å˜é‡ï¼</p>
</blockquote>
<p>So, we can <em>suspend</em> an async function? Okay great but.. what does that even mean?</p>
<p>Letâ€™s see what happens when we run the following block of code:</p>
<p><img src="/images/e5duygomitj9o455107a.gif"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">one</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'One!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'In Function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Before function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'After function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token string">"Before function!"</span>
<span class="token string">"In Function!"</span>
<span class="token string">"After function!"</span>
<span class="token string">"One!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Hmm.. Whatâ€™s happening here?</p>
<hr>
<p><img src="/images/d27d7xxiekczftjyic4b.gif"></p>
<p>First, the engine encounters a <code>console.log</code>. It gets popped onto the call stack, after which <code>Before function!</code> gets logged.</p>
<blockquote>
<p>é¦–å…ˆï¼Œå¼•æ“é‡åˆ°ä¸€ä¸ª <code>console.log</code>ã€‚å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œä¹‹åæ˜¯ <code>Before function!</code> è¢«è®°å½•ã€‚</p>
</blockquote>
<hr>
<p><img src="/images/9wqej2269vmntfcuxs9t.gif"></p>
<p>Then, we invoke the async function <code>myFunc()</code>, after which the function body of <code>myFunc</code> runs. On the very first line within the function body, we call another <code>console.log</code>, this time with the string <code>In function!</code>. The <code>console.log</code> gets added to the call stack, logs the value, and gets popped off.</p>
<blockquote>
<p>ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨å¼‚æ­¥å‡½æ•° <code>myFunc()</code>ï¼Œç„¶åè¿è¡Œ <code>â€‹â€‹myFunc</code> çš„å‡½æ•°ä½“ã€‚åœ¨å‡½æ•°ä½“çš„ç¬¬ä¸€è¡Œï¼Œæˆ‘ä»¬è°ƒç”¨å¦ä¸€ä¸ª <code>console.log</code>ï¼Œè¿™æ¬¡ä½¿ç”¨å­—ç¬¦ä¸² <code>In function!</code>ã€‚ <code>console.log</code> è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œè®°å½•å€¼ï¼Œç„¶åå¼¹å‡ºã€‚</p>
</blockquote>
<hr>
<p><img src="/images/lch6lutxnl88j0durpyh.gif"></p>
<p>The function body keeps on being executed, which gets us to the second line. Finally, we see an <code>await</code> keyword! ğŸ‰</p>
<blockquote>
<p>å‡½æ•°ä½“ç»§ç»­æ‰§è¡Œï¼Œè¿™è®©æˆ‘ä»¬è¿›å…¥ç¬¬äºŒè¡Œã€‚æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ª await å…³é”®å­—ï¼ ğŸ‰</p>
</blockquote>
<p>The first thing that happens is that the value that gets awaited gets executed: the function <code>one</code> in this case. It gets popped onto the call stack, and eventually returns a resolved promise. Once the promise has resolved and <code>one</code> returned a value, the engine encounters the <code>await</code> keyword.</p>
<blockquote>
<p>å‘ç”Ÿçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ç­‰å¾…çš„å€¼è¢«æ‰§è¡Œï¼šåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å‡½æ•° <code>one</code>ã€‚å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œå¹¶æœ€ç»ˆè¿”å›ä¸€ä¸ªå·²è§£å†³çš„æ‰¿è¯ºã€‚ä¸€æ—¦ promise å¾—åˆ°è§£å†³å¹¶è¿”å›ä¸€ä¸ªå€¼ï¼Œå¼•æ“å°±ä¼šé‡åˆ° await å…³é”®å­—ã€‚</p>
</blockquote>
<p>When encountering an <code>await</code> keyword, the <code>async</code> function gets <em>suspended</em>. âœ‹ğŸ¼ The execution of the function body <strong>gets paused</strong>, and the rest of the async function gets run in a <em>microtask</em> instead of a regular task!</p>
<blockquote>
<p>é‡åˆ° <code>await</code> å…³é”®å­—æ—¶ï¼Œå¼‚æ­¥å‡½æ•°ä¼šæš‚åœã€‚ âœ‹ğŸ¼ å‡½æ•°ä½“çš„æ‰§è¡Œè¢«æš‚åœï¼Œå¼‚æ­¥å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†åœ¨å¾®ä»»åŠ¡è€Œä¸æ˜¯å¸¸è§„ä»»åŠ¡ä¸­è¿è¡Œï¼</p>
</blockquote>
<hr>
<p><img src="/images/b6l3psgewvtrtmrr60tg.gif"></p>
<p>Now that the async function <code>myFunc</code> is suspended as it encountered the <code>await</code> keyword, the engine jumps out of the async function and continues executing the code in the execution context in which the async function got called: the <strong>global execution context</strong> in this case! ğŸƒğŸ½â€â™€ï¸</p>
<blockquote>
<p>ç°åœ¨å¼‚æ­¥å‡½æ•° <code>myFunc</code> åœ¨é‡åˆ° await å…³é”®å­—æ—¶è¢«æŒ‚èµ·ï¼Œå¼•æ“è·³å‡ºå¼‚æ­¥å‡½æ•°å¹¶ç»§ç»­åœ¨è°ƒç”¨å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ ğŸƒğŸ½â€â™€ï¸</p>
</blockquote>
<hr>
<p><img src="/images/hlhrtuspjyrstifubdhs.gif"></p>
<p>Finally, there are no more tasks to run in the global execution context! The event loop checks to see if there are any microtasks queued up: and there are! The async <code>myFunc</code> function is queued up after resolving the valued of <code>one</code>. <code>myFunc</code> gets popped back onto the call stack, and continues running where it previously left off(ä¸­æ–­).</p>
<blockquote>
<p>æœ€åï¼Œåœ¨å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰æ›´å¤šçš„ä»»åŠ¡è¦è¿è¡Œäº†ï¼äº‹ä»¶å¾ªç¯æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¾®ä»»åŠ¡æ’é˜Ÿï¼šç¡®å®æœ‰ï¼ async myFunc å‡½æ•°åœ¨è§£æå€¼ 1 åæ’é˜Ÿã€‚ myFunc è¢«å¼¹å›è°ƒç”¨å †æ ˆï¼Œå¹¶åœ¨å®ƒä¹‹å‰åœæ­¢çš„åœ°æ–¹ç»§ç»­è¿è¡Œï¼ˆä¸­æ–­ï¼‰ã€‚</p>
</blockquote>
<p>The variable <code>res</code> finally gets its value, namely the value of the resolved promise that <code>one</code> returned! We invoke <code>console.log</code> with the value of <code>res</code>: the string <code>One!</code> in this case. <code>One!</code> gets logged to the console and gets popped off the call stack! ğŸ˜Š</p>
<blockquote>
<p>å˜é‡ res ç»ˆäºå¾—åˆ°äº†å®ƒçš„å€¼ï¼Œå³è¿”å›çš„å·²è§£å†³çš„ promise çš„å€¼ï¼æˆ‘ä»¬ä½¿ç”¨ res çš„å€¼è°ƒç”¨ console.logï¼šå­—ç¬¦ä¸² Oneï¼åœ¨è¿™ç§æƒ…å†µä¸‹ã€‚ä¸€ï¼ç™»å½•åˆ°æ§åˆ¶å°å¹¶ä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºï¼ ğŸ˜Š</p>
</blockquote>
<p>Finally, all done! Did you notice how <code>async</code> functions are different compared to a promise <code>then</code>? The <code>await</code> keyword <em>suspends</em> the <code>async</code> function, whereas the Promise body wouldâ€™ve kept on being executed if we wouldâ€™ve used <code>then</code>!</p>
<blockquote>
<p>æœ€åï¼Œä¸€åˆ‡éƒ½å®Œæˆäº†ï¼æ‚¨æ˜¯å¦æ³¨æ„åˆ°å¼‚æ­¥å‡½æ•°ä¸ promise ç›¸æ¯”æœ‰ä½•ä¸åŒï¼Ÿ await å…³é”®å­—æš‚åœäº†å¼‚æ­¥å‡½æ•°ï¼Œè€Œå¦‚æœæˆ‘ä»¬å½“æ—¶ä½¿ç”¨çš„è¯ï¼ŒPromise ä¸»ä½“å°†ç»§ç»­æ‰§è¡Œï¼</p>
</blockquote>
<hr>
<p>Hm that was quite a lot of information! ğŸ¤¯ No worries at all if you still feel a bit overwhelmed when working with Promises, I personally feel that it just takes experience to notice patterns and feel confident when working with asynchronous JavaScript.</p>
<blockquote>
<p>å—¯ï¼Œè¿™æ˜¯ç›¸å½“å¤šçš„ä¿¡æ¯ï¼ ğŸ¤¯ å¦‚æœæ‚¨åœ¨ä½¿ç”¨ Promises æ—¶ä»ç„¶æ„Ÿåˆ°æœ‰ç‚¹ä¸çŸ¥æ‰€æªï¼Œè¯·å®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä¸ªäººè®¤ä¸ºåªéœ€è¦ç»éªŒæ¥æ³¨æ„æ¨¡å¼å¹¶åœ¨ä½¿ç”¨å¼‚æ­¥ JavaScript æ—¶æ„Ÿåˆ°è‡ªä¿¡ã€‚</p>
</blockquote>
<p>However, I hope that the â€œunexpectedâ€ or â€œunpredictableâ€ behavior that you might encounter when working with async JavaScript makes a bit more sense now!</p>
<blockquote>
<p>ä½†æ˜¯ï¼Œæˆ‘å¸Œæœ›æ‚¨åœ¨ä½¿ç”¨å¼‚æ­¥ JavaScript æ—¶å¯èƒ½é‡åˆ°çš„â€œæ„å¤–â€æˆ–â€œä¸å¯é¢„æµ‹â€è¡Œä¸ºç°åœ¨æ›´æœ‰æ„ä¹‰äº†ï¼</p>
</blockquote>
<hr>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.javascript.info/async">Promise,async/await</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise - JavaScript | MDN</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async function</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">await</a></li>
</ul>

                
            </div>
            <hr/>

            
    
        <div class="reprint" id="reprint-statement">
            
                <div class="reprint__author">
                    <span class="reprint-meta" style="font-weight: bold;">
                        <i class="fas fa-user">
                            æ–‡ç« ä½œè€…:
                        </i>
                    </span>
                    <span class="reprint-info">
                        <a href="/about" rel="external nofollow noreferrer">
                            Lydia Hallie
                        </a>
                    </span>
                </div>
                <div class="reprint__type">
                    <span class="reprint-meta" style="font-weight: bold;">
                        <i class="fas fa-link">
                            æ–‡ç« é“¾æ¥:
                        </i>
                    </span>
                    <span class="reprint-info">
                        <a href="https://zhuangyin8.github.io/javascript-visualized-promises-async-await/">
                            https://zhuangyin8.github.io
                                /javascript-visualized-promises-async-await/
                        </a>
                    </span>
                </div>
                <div class="reprint__notice">
                    <span class="reprint-meta" style="font-weight: bold;">
                        <i class="fas fa-copyright">
                            ç‰ˆæƒå£°æ˜:
                        </i>
                    </span>
                    <span class="reprint-info">
                        æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                            <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">
                                CC BY 4.0
                            </a>
                            è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                                <a href="/about" target="_blank">
                                    Lydia Hallie
                                </a>
                                !
                    </span>
                </div>
                
        </div>
        <script async defer>
            document.addEventListener("copy", function (e) {
                let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
                M.toast({ html: toastHTML })
            });
            function navToReprintStatement() {
                $("html, body").animate({ scrollTop: $("#reprint-statement").offset().top - 80 }, 800);
            }
        </script>
        

            <div class="tag_share">
                <div class="post-meta__tag-list">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Visualized/">
                                    <span class="chip bg-color">Visualized</span>
                                </a>
                            
                                <a href="/tags/Promises/">
                                    <span class="chip bg-color">Promises</span>
                                </a>
                            
                                <a href="/tags/Async/">
                                    <span class="chip bg-color">Async</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<!-- <div id="article-share"> -->
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    
<!-- </div> -->


                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 450px;
        height: 600px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform: scale(1.3);
        -webkit-transform: scale(1.3);
        -o-transform: scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 420px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 380px;
        height: 450px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpeg" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comment" aria-hidden="true"></i>
        <span>è¯„è®º</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '215267d8d7dec30a72c0',
        clientSecret: 'ffb94989b6dda7c638a855388a4bb4b95417bfc2',
        repo: 'zhuangyin8.github.io',
        owner: 'zhuangyin8',
        admin: "zhuangyin8",
        id: '2020-04-15T00-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/10-css-tricks-you-need-to-know-about/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="10 CSS Tricks You Need to Know About">
                        
                        <span class="card-title">10 CSS Tricks You Need to Know About</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                        
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock icon-date"></i>2020-05-19
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark icon-category"></i>
                            
                            <a href="/categories/CSS/" class="post-category">
                                CSS
                            </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Tricks/">
                        <span class="chip bg-color">Tricks</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/cs-visualized-useful-git-commands/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="ğŸŒ³ğŸš€ CS Visualized: Useful Git Commands">
                        
                        <span class="card-title">ğŸŒ³ğŸš€ CS Visualized: Useful Git Commands</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                        
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock icon-date"></i>2020-04-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark icon-category"></i>
                            
                            <a href="/categories/Git/" class="post-category">
                                Git
                            </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Visualized/">
                        <span class="chip bg-color">Visualized</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i> 
                ç›®å½•
            </div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
            /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
            let fixPostCardWidth = function (srcId, targetId) {
                let srcDiv = $('#' + srcId);
                if (srcDiv.length === 0) {
                    return;
                }

                let w = srcDiv.width();
                if (w >= 450) {
                    w = w + 21;
                } else if (w >= 350 && w < 450) {
                    w = w + 18;
                } else if (w >= 300 && w < 350) {
                    w = w + 16;
                } else {
                    w = w + 14;
                }
                $('#' + targetId).width(w);
            };

            // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
            const expandedClass = 'expanded';
            let $tocAside = $('#toc-aside');
            let $mainContent = $('#main-content');
            $('#floating-toc-btn .btn-floating').click(function () {
                if ($tocAside.hasClass(expandedClass)) {
                    $tocAside.removeClass(expandedClass).hide();
                    $mainContent.removeClass('l9');
                } else {
                    $tocAside.addClass(expandedClass).show();
                    $mainContent.addClass('l9');
                }
                fixPostCardWidth('artDetail', 'prenext-posts');
            }); 
        
    });
</script>
    

</main>




    <footer class="page-footer bg-color">
    
    <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        display: none;
            font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        display: none;
            font-size: 15px;
        color: #42b983;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
            left: -66px !important;
        }

        .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
            left: 0px !important;
        }

        
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="694322774" fixed='true' autoplay='false' theme='#42b983' loop='all' order='random' preload='auto' volume='0.7' list-folded='true'>
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&copy;
            
            <span id="year">2016-2021</span>
            
            <span id="year">2016</span>
            <a href="/about" target="_blank">åº„å¼•</a>
            <br>
            Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
            Theme <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                <i class="fa fa-eye"></i>
                æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv" class="white-color"></span> æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                <i class="fa fa-users"></i>
                æ€»è®¿é—®äººæ•°: <span id="busuanzi_value_site_uv" class="white-color"></span> äºº
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
<a href="https://github.com/zhuangyin8" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
    <i class="fab fa-github"></i>
</a>



<a href="mailto:zhuangyin8@gmail.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
    <i class="fas fa-envelope-open"></i>
</a>









<a href="https://weibo.com/zhuangyinzhi" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„å¾®åš: https://weibo.com/zhuangyinzhi" data-position="top" data-delay="50">
    <i class="fab fa-weibo"></i>
</a>





<a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
    <i class="fas fa-rss"></i>
</a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        var searchFunc = function (path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function (xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function () {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function () {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function (data) {
                            var isMatch = true;
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title !== '' && data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i === 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start === 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substr(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                    });
                                    str += "<p class=\"search-result\">" + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        };
        searchFunc('/search.xml', 'searchInput', 'searchResult');
    });
</script>
    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-double-up"></i>
    </a>
</div>

    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>